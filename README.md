# –ö–æ–ºfy-UI-Orchestrator

–†–µ—à–µ–Ω–∏–µ –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ ComfyUI —Å –ø–æ–º–æ—â—å—é –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º.

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–∫–æ–π –∑–∞–¥–∞—á–∏ –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è API ComfyUI (HTTP + WebSocket). –í–Ω–µ—à–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ **–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞**, –∫–æ—Ç–æ—Ä—ã–π –±–µ—Ä—ë—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON-—à–∞–±–ª–æ–Ω –≤–æ—Ä–∫—Ñ–ª–æ—É (workflow) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.

–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–≤–µ —Å—Ö–µ–º—ã: **Sequence Diagram** (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è) –∏ **Flowchart** (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö).

---

## 1. Sequence Diagram: –ü—Ä–æ—Ü–µ—Å—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

–≠—Ç–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –≤–Ω–µ—à–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—à–∞–≥–æ–≤–æ –æ–±—â–∞–µ—Ç—Å—è —Å ComfyUI.

```mermaid
sequenceDiagram
    autonumber
    participant Script as –°—Ü–µ–Ω–∞—Ä–∏–π / –ë–î
    participant ExtSystem as –í–Ω–µ—à–Ω—è—è –°–∏—Å—Ç–µ–º–∞<br/>(Python/Node.js)
    participant ComfyWS as ComfyUI WebSocket
    participant ComfyAPI as ComfyUI HTTP API
    participant Storage as –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞<br/>(Output)

    Note over ExtSystem: 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    Script->>ExtSystem: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è (Prompt, Seed, Params)
    ExtSystem->>ExtSystem: –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ Workflow (workflow_api.json)
    ExtSystem->>ExtSystem: –ò–Ω—ä–µ–∫—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ –≤ Node ID (–Ω–∞–ø—Ä. ID: 6)
    ExtSystem->>ExtSystem: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ Seed (–Ω–∞–ø—Ä. ID: 3)

    Note over ExtSystem, ComfyWS: 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
    ExtSystem->>ComfyWS: –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (client_id)
    ExtSystem->>ComfyAPI: POST /prompt<br/>{client_id, prompt: JSON}
    ComfyAPI-->>ExtSystem: {prompt_id, number, node_errors}

    Note over ComfyWS: 3. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ
    loop –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        ComfyWS-->>ExtSystem: status {exec_info: {queue_remaining: N}}
        ComfyWS-->>ExtSystem: executing {node: "KSampler", step: 5/20}
        ComfyWS-->>ExtSystem: execution_success {prompt_id, output: {images: [...]}}
    end

    Note over ExtSystem, Storage: 4. –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    ExtSystem->>ComfyAPI: GET /view?filename=...&type=output
    ComfyAPI-->>ExtSystem: Binary Image Data
    ExtSystem->>Storage: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ / –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—É
```

---

## 2. Architecture Flowchart: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

–≠—Ç–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ –≥–æ—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é JSON.

```mermaid
flowchart TD
    subgraph External_System [–í–Ω–µ—à–Ω—è—è –°–∏—Å—Ç–µ–º–∞ / –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä]
        Script[("–°—Ü–µ–Ω–∞—Ä–∏–π / –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö<br>(–¢–µ–∫—Å—Ç—ã, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã)")]
        Template[("Workflow API Template<br>(JSON —Ñ–∞–π–ª)")]
        
        Parser["–ü–∞—Ä—Å–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è"]
        Injector["JSON Manipulator<br>(–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ Node ID)"]
        
        Script --> Parser
        Template --> Injector
        Parser -- "1. –¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ (Clip Text Encode)" --> Injector
        Parser -- "2. Seed / Steps (KSampler)" --> Injector
        Parser -- "3. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (Empty Latent)" --> Injector
    end

    subgraph ComfyUI_Server [ComfyUI –°–µ—Ä–≤–µ—Ä]
        API_Rec["API Endpoint (/prompt)"]
        Queue["–û—á–µ—Ä–µ–¥—å (Queue)"]
        Engine["Comfy Engine (Execution)"]
        WS_Sender["WebSocket Broadcaster"]
        
        Injector -- "4. –û—Ç–ø—Ä–∞–≤–∫–∞ Payload (JSON)" --> API_Rec
        API_Rec --> Queue
        Queue --> Engine
        Engine -- "–°—Ç–∞—Ç—É—Å / –ü—Ä–æ–≥—Ä–µ—Å—Å" --> WS_Sender
    end

    subgraph Outputs [–†–µ–∑—É–ª—å—Ç–∞—Ç—ã]
        Images["–ü–∞–ø–∫–∞ Output"]
        ExtStorage["–í–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"]
    end

    WS_Sender -.->|–°–æ–æ–±—â–µ–Ω–∏—è| External_System
    Engine --> Images
    External_System -- "5. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ (GET /view)" --> Images
    External_System --> ExtStorage
```

---

## –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —ç—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å, –≤–æ—Ç —á—Ç–æ –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å (—á—Ç–æ –æ—Ç—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Å—Ö–µ–º–∞—Ö):

### üìã –§–æ—Ä–º–∞—Ç Workflow (API vs Standard)
ComfyUI –∏–º–µ–µ—Ç –¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞ JSON. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–∫–æ—Ç–æ—Ä—ã–π –≤—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –∫–Ω–æ–ø–∫–æ–π Save) —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ UI (–ø–æ–∑–∏—Ü–∏–∏ —É–∑–ª–æ–≤).

–î–ª—è –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º—ã –≤–∞–º –Ω—É–∂–µ–Ω API Format. –í ComfyUI –≤–∫–ª—é—á–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ¬´Enable Dev mode Options¬ª, —Ç–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ¬´Save (API Format)¬ª. –ò–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç JSON –æ–∂–∏–¥–∞–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç `/prompt`.

### üî¢ –ê–¥—Ä–µ—Å–∞—Ü–∏—è —É–∑–ª–æ–≤ (Node IDs)
–í–Ω–µ—à–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ —Ç–∞–∫–æ–µ ¬´Positive Prompt¬ª. –û–Ω–∞ –∑–Ω–∞–µ—Ç —Ç–æ–ª—å–∫–æ Node ID.

–í–∞–º –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–Ω–∞—Ç—å, —á—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, —É–∑–µ–ª —Å `"id": "6"` ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞, –∞ —É–∑–µ–ª `"3"` ‚Äî —ç—Ç–æ KSampler. –í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –º–µ–Ω—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ inputs —ç—Ç–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö ID.

### üîó –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ WebSocket
HTTP –∑–∞–ø—Ä–æ—Å –Ω–∞ `/prompt` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (—á—Ç–æ –∑–∞–¥–∞—á–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å).

–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≥–æ—Ç–æ–≤–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ —Å–ª—É—à–∞—Ç—å WebSocket. –ò—â–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ `executing` (—Ç–µ–∫—É—â–∏–π —É–∑–µ–ª) –∏ `execution_success` (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ).

### üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

ComfyUI –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞ WebSocket –∏–ª–∏ HTTP POST.

–û–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞.

–í–∞–º –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π GET –∑–∞–ø—Ä–æ—Å: 
```
http://host:8188/view?filename=Image_001.png&subfolder=&type=output
```